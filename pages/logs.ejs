<!-- ////////////////// - PARTIALS - ////////////////// -->

<%- include('partials/socket.ejs') %>
    <%- include('partials/header.ejs') %>
        <%- include('partials/messageModals.ejs') %>
            <%- include('partials/navigation.ejs') %>

                &nbsp;
                <br>

                <hr class="divider">

                <style>
                    .log-year-container,
                    .log-month-container,
                    .log-day-container {
                        position: relative;
                        left: 3px;
                        max-height: 0px;
                        padding: 3px;
                        margin-top: 5px;
                        text-align: left;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0px 3px 7px 0px var(--break-list-item-shadow-color);
                        background: linear-gradient(var(--break-list-item-background-color), var(--break-list-item-background-color)) padding-box,
                            linear-gradient(to bottom, var(--break-list-item-sidegradient1-color), var(--break-list-item-sidegradient2-color)) border-box;
                        color: var(--break-list-item-text-color);
                        border: 1px solid transparent;
                        border-radius: 10px;
                        vertical-align: middle;
                        opacity: 0;
                        overflow: hidden;
                        transition: all 10s ease;
                    }

                    .visible {
                        opacity: 1;
                        max-height: 99999px;
                        /* Set the desired expanded max-height */
                    }

                    .log-month-container,
                    .log-day-container {
                        display: none;
                    }

                    .open {
                        display: block;
                    }

                    .log-year-container {
                        width: 270px;
                    }

                    .log-month-container {
                        width: 256px;
                    }

                    .log-day-container {
                        width: 242px;
                    }

                    .log-year button,
                    .log-month button,
                    .log-day button {
                        font-family: 'M PLUS 1';
                        top: 5px;
                        background: none;
                        border: none;
                        color: var(--links-color);
                        cursor: pointer;
                        margin-left: 0px;
                        transition: color 0.5s ease;
                        font-size: 14px;
                        text-align: left;
                        color: #ffffff;
                        padding: 5px 10px;
                        border-radius: 4px;
                        transition: all 0.3s ease;
                    }

                    .log-year {
                        position: relative;
                        top: 0px;
                    }

                    .log-year button:hover,
                    .log-month button:hover,
                    .log-day button:hover {
                        font-family: 'M PLUS 1';
                    }

                    .log-year button .button-content:hover .arrow-logs,
                    .log-month button .button-content:hover .arrow-logs,
                    .log-day button .button-content:hover .arrow-logs {
                        color: var(--links-hover-color);
                    }

                    .arrow-logs {
                        color: var(--break-list-item-icons-color);
                        position: relative;
                        top: 0px;
                        left: -8px;
                        margin-right: -8px;
                        display: inline-block;
                        cursor: pointer;
                        transform-origin: center center;
                        font-size: 20px;
                        transition: all var(--animation-duration-min) ease-in-out;
                        transition: transform var(--animation-duration-min) ease-in-out;
                    }

                    .arrow-logs:hover {
                        color: var(--links-hover-color);
                    }

                    .dl-d-icons-container-year {
                        position: relative;
                        left: 120px;
                    }

                    .dl-d-icons-container-month {
                        position: relative;
                        left: 123px;
                    }

                    .dl-d-icons-container-day {
                        position: relative;
                        left: 38px;
                    }

                    .dl-d-icons {
                        font-size: 18px;
                        position: relative;
                        top: 0px;
                        margin-right: -10px;
                        vertical-align: middle;
                        transform: scale(0.9);
                    }

                    .dl-d-icons:hover {
                        color: var(--links-hover-color);
                    }

                    .folder-buttons-logfile,
                    .folder-buttons {
                        color: var(--break-list-item-text-color);
                        position: relative;
                        top: 1px;
                    }

                    .log-button {
                        margin-left: auto;
                    }

                    .rotate {
                        transform: rotate(90deg);
                        transition: transform var(--animation-duration-min) ease-in-out;
                    }

                    .material-symbols-outlined {
                        color: var(--break-list-item-icons-color);
                        vertical-align: middle;
                        transition: all var(--animation-duration-min) ease-in-out;
                    }

                    .log-month-row {
                        position: relative;
                        width: 100%;
                    }
                </style>

                <greet>Logs</greet>

                <br><br><br>

                <% logs.forEach((logYear, yearIndex)=> { %>
                    <div class="log-year-container">
                        <div class="log-year" id="year<%= yearIndex %>">
                            <button onclick="toggleLogsContainer(this)">
                                <span class="button-content">
                                    <span class="material-symbols-outlined arrow-logs">keyboard_arrow_right</span>
                                    <span class="folder-buttons">
                                        <%= logYear.year %>
                                    </span>
                                </span>
                            </button>
                            <!-- Download Button for Year Folder -->
                            <span class="dl-d-icons-container-year">
                                <button class="log-button"
                                    onclick="downloadYearLogs('<%= logYear.year %>', '<%= JSON.stringify(logYear.months) %>')">
                                    <i class="material-symbols-outlined dl-d-icons"
                                        style="display: inline-block;">get_app</i>
                                </button>
                                <!-- Delete Button for Year Folder -->
                                <button class="log-button" onclick="deleteYearLogs('<%= logYear.year %>')">
                                    <i class="material-symbols-outlined dl-d-icons"
                                        style="display: inline-block;">close</i>
                                </button>
                            </span>
                            <div class="log-month-container">
                                <% logYear.months.forEach((logMonth, monthIndex)=> { %>
                                    <div class="log-month-row">
                                        <div class="log-month" id="month<%= monthIndex %>">
                                            <button onclick="toggleLogsContainer(this)">
                                                <span class="button-content">
                                                    <span
                                                        class="material-symbols-outlined arrow-logs">keyboard_arrow_right</span>
                                                    <span class="folder-buttons">
                                                        <%= logMonth.month %>
                                                    </span>
                                                </span>
                                            </button>
                                            <!-- Download Button for Month Folder -->
                                            <span class="dl-d-icons-container-month">
                                                <button class="log-button"
                                                    onclick="downloadMonthLogs('<%= logYear.year %>', '<%= logMonth.month %>', '<%= JSON.stringify(logMonth.logs) %>')">
                                                    <i class="material-symbols-outlined dl-d-icons"
                                                        style="display: inline-block;">get_app</i>
                                                </button>
                                                <!-- Delete Button for Month Folder -->
                                                <button class="log-button"
                                                    onclick="deleteMonthLogs('<%= logYear.year %>', '<%= logMonth.month %>')">
                                                    <i class="material-symbols-outlined dl-d-icons"
                                                        style="display: inline-block;">close</i>
                                                </button>
                                            </span>
                                            <div class="log-day-container">
                                                <% logMonth.logs.forEach(logFile=> { %>
                                                    <div class="log-day" onclick="event.stopPropagation()">
                                                        <button class="log-button"
                                                            onclick="fetchLogContent('<%= logYear.year %>', '<%= logMonth.month %>', '<%= logFile %>')">
                                                            <span class="folder-buttons-logfile">
                                                                <%= logFile %>
                                                            </span>
                                                        </button>
                                                        <!-- Download Button for Daily Logs -->
                                                        <span class="dl-d-icons-container-day">
                                                            <button class="log-button"
                                                                onclick="downloadLogFile('<%= logYear.year %>', '<%= logMonth.month %>', '<%= logFile %>')">
                                                                <i class="material-symbols-outlined dl-d-icons"
                                                                    style="display: inline-block;">get_app</i>
                                                            </button>
                                                            <!-- Delete Button for Daily Logs -->
                                                            <button class="log-button"
                                                                onclick="deleteLogFile('<%= logYear.year %>', '<%= logMonth.month %>', '<%= logFile %>')">
                                                                <i class="material-symbols-outlined dl-d-icons"
                                                                    style="display: inline-block;">close</i>
                                                            </button>
                                                        </span>
                                                    </div>
                                                    <% }); %>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>

                            </div>
                        </div>
                    </div>
                    <% }); %>


                        <script>
                            const toggleLogsContainer = (button) => {
                                const parentElement = button.parentElement;
                                const logsContainer = parentElement.querySelector('.log-month-container, .log-day-container') || parentElement.querySelector('.log-year-container');
                                const arrow = button.querySelector('.arrow-logs');
                                if (logsContainer && arrow) {
                                    logsContainer.classList.toggle('open');
                                    arrow.classList.toggle('rotate');
                                    if (logsContainer.classList.contains('open')) {
                                        logsContainer.style.maxHeight = (logsContainer.scrollHeight+10000) + 'px'; // Set the dynamic max-height
                                    } else {
                                        logsContainer.style.maxHeight = '0'; // Collapse the container by setting max-height to 0
                                    }
                                    saveMenuState();
                                }
                            };


                            const saveMenuState = () => {
                                const menuState = {};
                                const logContainers = document.querySelectorAll('.log-year-container, .log-month-container, .log-day-container');
                                logContainers.forEach(container => {
                                    const id = container.parentElement.id;
                                    const isOpen = container.classList.contains('open');
                                    menuState[id] = isOpen;
                                });
                                localStorage.setItem('menuState', JSON.stringify(menuState));
                            }

                            const loadMenuState = () => {
                                const menuState = JSON.parse(localStorage.getItem('menuState'));
                                if (menuState) {
                                    for (const id in menuState) {
                                        const isOpen = menuState[id];
                                        const container = document.getElementById(id);
                                        if (isOpen && container) {
                                            const logsContainer = container.querySelector('.log-year-container, .log-month-container, .log-day-container');
                                            if (logsContainer) {
                                                container.querySelector('.arrow-logs').classList.add('rotate');
                                                logsContainer.classList.add('open');
                                            }
                                        }
                                    }
                                }
                            }


                            window.addEventListener('DOMContentLoaded', () => {
                                const logContainers = document.querySelectorAll('.log-year-container, .log-month-container, .log-day-container');
                                logContainers.forEach((container, index) => {
                                    setTimeout(() => {
                                        container.classList.add('visible');
                                    }, 200 * (index + 1)); // delay for the effect to start
                                });
                                loadMenuState();
                            });

                            const fetchLogContent = async (year, month, day) => {
                                try {
                                    const response = await fetch(`/logs/${year}/${month}/${day}`);
                                    const data = await response.json();

                                    let params = 'toolbar=no, popup=yes, directories=no, titlebar=no, toolbar=no, location=no, status=no, menubar=no, scrollbars=no, resizable=no,width=750,height=450,left=100,top=100';
                                    let logWindow = window.open('', '', params);

                                    logWindow.document.write(`
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <title>Log: ${year}/${month}/${day}</title>
                                    <style>
                                        body {
                                            background-color: black;
                                            color: white;
                                        }
                                        pre {
                                            white-space: pre-wrap; 
                                            white-space: -moz-pre-wrap; 
                                            white-space: -pre-wrap; 
                                            white-space: -o-pre-wrap;
                                            word-wrap: break-word; 
                                        }

                                        span {
                                            font-family:'Courier New', Courier, monospace;
                                            font-size: 12px;
                                        }
                                    </style>
                                </head>
                                <body>
                                    <span>File > ${day}<br></span>
                                    <pre>${data.data}</pre>
                                </body>
                                </html>
                            `);

                                    logWindow.document.close();
                                } catch (error) {
                                    console.error("Error fetching log content:", error);
                                }
                            }

                            const downloadLogFile = (year, month, day) => {
                                const link = document.createElement('a');
                                link.href = `/logs/${year}/${month}/${day}/download`;
                                link.download = `${year}-${month}-${day}.log`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }

                            const deleteLogFile = async (year, month, day) => {
                                try {
                                    const response = await fetch(`/logs/${year}/${month}/${day}`, { method: 'DELETE' });
                                    if (response.ok) {
                                        console.log('Log file successfully deleted');
                                        location.reload();
                                    }
                                } catch (error) {
                                    console.error("Error deleting log file:", error);
                                }
                            }

                            const downloadMonthLogs = async (year, month) => {
                                try {
                                    const response = await fetch(`/logs/${year}/${month}/download`, { method: 'GET' });
                                    if (!response.ok) {
                                        throw new Error('Download failed');
                                    }

                                    const blob = await response.blob();
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.target = '_blank';
                                    a.download = `${year}-${month}-logs.zip`;
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                } catch (error) {
                                    console.error('Error during download:', error);
                                }
                            };

                            const downloadYearLogs = async (year) => {
                                try {
                                    const response = await fetch(`/logs/${year}/download`, { method: 'GET' });
                                    if (!response.ok) {
                                        throw new Error('Download failed');
                                    }

                                    const blob = await response.blob();
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.target = '_blank';
                                    a.download = `${year}-logs.zip`;
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                } catch (error) {
                                    console.error('Error during download:', error);
                                }
                            };

                            const deleteMonthLogs = async (year, month) => {
                                try {
                                    const response = await fetch(`/logs/${year}/${month}`, { method: 'DELETE' });
                                    if (response.ok) {
                                        console.log('Logs for the month successfully deleted');
                                        location.reload();
                                    }
                                } catch (error) {
                                    console.error('Error deleting logs for the month:', error);
                                }
                            };

                            const deleteYearLogs = async (year) => {
                                try {
                                    const response = await fetch(`/logs/${year}`, { method: 'DELETE' });
                                    if (response.ok) {
                                        console.log('Logs for the year successfully deleted');
                                        location.reload();
                                    }
                                } catch (error) {
                                    console.error('Error deleting logs for the year:', error);
                                }
                            };

                        </script>

                        <!-- ////////////////// - ARROW HOVERING - ////////////////// -->

                        <script>

                            // get CSS variables
                            let styles = getComputedStyle(document.documentElement);
                            let linksColor = styles.getPropertyValue('--links-color').trim();
                            let linksHoverColor = styles.getPropertyValue('--links-hover-color').trim();

                            // add event listeners for year containers
                            document.querySelectorAll('.log-year-container').forEach((container) => {
                                let arrowIcon = container.querySelector('.log-year .arrow-logs');
                                let closeButton = container.querySelector('.log-year .dl-d-icons-container-year .dl-d-icons');

                                container.addEventListener('mouseover', function () {
                                    if (arrowIcon) {
                                        arrowIcon.style.color = linksHoverColor;
                                    }
                                });

                                container.addEventListener('mouseout', function () {
                                    if (arrowIcon) {
                                        arrowIcon.style.color = linksColor;
                                    }
                                });

                                if (closeButton) {
                                    closeButton.addEventListener('mouseover', function () {
                                        if (arrowIcon) {
                                            arrowIcon.style.color = linksColor;
                                        }
                                    });

                                    closeButton.addEventListener('mouseout', function () {
                                        if (arrowIcon) {
                                            arrowIcon.style.color = '';
                                        }
                                    });
                                }

                                container.addEventListener('click', function () {
                                    let button = container.querySelector('.log-year button');
                                    if (button) {
                                        button.click();
                                    }
                                });

                            });

                            // add event listeners for month containers
                            document.querySelectorAll('.log-month-row').forEach((row) => { // Change the selector
                                let arrowIcon = row.querySelector('.log-month .arrow-logs');
                                let closeButton = row.querySelector('.log-month .dl-d-icons-container-month .dl-d-icons');

                                row.addEventListener('mouseover', function () { // Change the variable
                                    if (arrowIcon) {
                                        arrowIcon.style.color = linksHoverColor;
                                    }
                                });

                                row.addEventListener('mouseout', function () { // Change the variable
                                    if (arrowIcon) {
                                        arrowIcon.style.color = linksColor;
                                    }
                                });

                                if (closeButton) {
                                    closeButton.addEventListener('mouseover', function () {
                                        if (arrowIcon) {
                                            arrowIcon.style.color = linksColor;
                                        }
                                    });

                                    closeButton.addEventListener('mouseout', function () {
                                        if (arrowIcon) {
                                            arrowIcon.style.color = '';
                                        }
                                    });
                                }

                                row.addEventListener('click', function () {
                                    let button = row.querySelector('.log-month button');
                                    if (button) {
                                        button.click();
                                    }
                                });
                            });


                        </script>

                        <br><br><br>

                        <!-- ////////////// - BOTTOM PARTIALS - ////////////////-->

                        <%- include('partials/bottomjs.ejs') %>